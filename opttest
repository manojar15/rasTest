WITH base_period AS (
  SELECT 
    ARID_ITEM,
    BALTT_CODE,
    AABPTL_AMT,
    AABPTL_END_DATE
  FROM uat7400_racs11.TB_APD_AR_BAL_PERIOD_LN_RL
  WHERE AABPTL_VALUE = 'Yearly'
    AND BALTT_CODE IN ('TotalFeeCollected', 'TotalInterestCollected')
    AND (
      SUBSTRING('20250728', 1, 4) = SUBSTRING(AABPTL_END_DATE, 1, 4)
      OR (SUBSTRING('20250728', 1, 4) - 1) = SUBSTRING(AABPTL_END_DATE, 1, 4)
    )
),
TOT_FEES_YTD AS (
  SELECT ARID_ITEM, AABPTL_AMT
  FROM base_period
  WHERE BALTT_CODE = 'TotalFeeCollected'
    AND SUBSTRING('20250728', 1, 4) = SUBSTRING(AABPTL_END_DATE, 1, 4)
),
TOT_INT_YTD AS (
  SELECT ARID_ITEM, AABPTL_AMT
  FROM base_period
  WHERE BALTT_CODE = 'TotalInterestCollected'
    AND SUBSTRING('20250728', 1, 4) = SUBSTRING(AABPTL_END_DATE, 1, 4)
),
TOT_FEES_PREV_YTD AS (
  SELECT ARID_ITEM, AABPTL_AMT
  FROM base_period
  WHERE BALTT_CODE = 'TotalFeeCollected'
    AND (SUBSTRING('20250728', 1, 4) - 1) = SUBSTRING(AABPTL_END_DATE, 1, 4)
),
TOT_INT_PREV_YTD AS (
  SELECT ARID_ITEM, AABPTL_AMT
  FROM base_period
  WHERE BALTT_CODE = 'TotalInterestCollected'
    AND (SUBSTRING('20250728', 1, 4) - 1) = SUBSTRING(AABPTL_END_DATE, 1, 4)
)
SELECT DISTINCT
  '791' AS `REC_TYP`,
  (DRIVING_TABLE.ar_id_item||'-'||'DetailedLOCStatement') AS FILTER_VAL,
  1 AS `sort_order`,
  '791' AS `sort_order_1`,
  (DRIVING_TABLE.ar_id_item||'-'||DRIVING_TABLE.IP_ID) AS `accnt_nmbr`,
  DRIVING_TABLE.ADT_MSG_UUID AS `uuid`,
  '' AS `Over Limit Amount`,
  '' AS `Resolved Amount`,
  '' AS `VAT Total for Period`,
  '' AS `Capitalized Interest at Billing`,
  REPLACE(CAST(COALESCE(TOT_FEES_YTD.AABPTL_AMT, CAST(0 AS BIGINT)) AS NUMERIC(26, 4)), '.', '') AS `Total Fees Assessed YTD`,
  REPLACE(CAST(COALESCE(TOT_INT_YTD.AABPTL_AMT, CAST(0 AS BIGINT)) AS NUMERIC(26, 4)), '.', '') AS `Total Interest Earned YTD`,
  REPLACE(CAST(COALESCE(TOT_FEES_PREV_YTD.AABPTL_AMT, CAST(0 AS BIGINT)) AS NUMERIC(26, 4)), '.', '') AS `Total Fees Assessed Previous YTD`,
  REPLACE(CAST(COALESCE(TOT_INT_PREV_YTD.AABPTL_AMT, CAST(0 AS BIGINT)) AS NUMERIC(26, 4)), '.', '') AS `Total Interest Earned Previous YTD`
FROM uat7400_racs11.RT_AR_STMNT_LN_RL DRIVING_TABLE
LEFT JOIN TOT_FEES_YTD
  ON DRIVING_TABLE.AR_ID_ITEM = TOT_FEES_YTD.ARID_ITEM
LEFT JOIN TOT_INT_YTD
  ON DRIVING_TABLE.AR_ID_ITEM = TOT_INT_YTD.ARID_ITEM
LEFT JOIN TOT_FEES_PREV_YTD
  ON DRIVING_TABLE.AR_ID_ITEM = TOT_FEES_PREV_YTD.ARID_ITEM
LEFT JOIN TOT_INT_PREV_YTD
  ON DRIVING_TABLE.AR_ID_ITEM = TOT_INT_PREV_YTD.ARID_ITEM
WHERE
  DRIVING_TABLE.FULL_DATE = '20250728'
  AND DRIVING_TABLE.STLR_STMNT_TYPE = 'DetailedStatement'
  AND DRIVING_TABLE.enart_value LIKE '%LineOfCredit%';
