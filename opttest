CREATE TEMPORARY TABLE ULR014_TEMP1 AS
WITH
-- Filter base table early to reduce join sizes
A AS (
  SELECT
    FULL_DATE,
    argblr_bill_status,
    argblr_bill_due_date,
    argblr_paid_date,
    AR_ID_ITEM,
    ARGBLR_BILL_AMT,
    LDBID
  FROM uat7400_racs11.RT_AR_GEN_BILL_HIST_LN_RL
  WHERE argblr_bill_status = 'Paid'
    AND argblr_bill_due_date > argblr_paid_date
    AND argblr_paid_date BETWEEN '2025-07-28' AND '2025-07-28'
),

-- Latest snapshot for C (daily balance) using window rank
C_latest AS (
  SELECT *
  FROM (
    SELECT
      C1.*,
      ROW_NUMBER() OVER (ORDER BY FULL_DATE DESC) AS rn
    FROM uat7400_racs11.RT_AR_DLY_BAL_LN_RL C1
  ) t
  WHERE rn = 1
),

-- Latest snapshot for D (contract period) using window rank
D_latest AS (
  SELECT *
  FROM (
    SELECT
      D1.*,
      ROW_NUMBER() OVER (ORDER BY FULL_DATE DESC) AS rn
    FROM uat7400_racs11.TB_APD_AR_CNTR_PERIOD_LN_RL D1
  ) t
  WHERE rn = 1
)

SELECT
  A.FULL_DATE,
  A.argblr_bill_status,
  A.argblr_bill_due_date,
  A.argblr_paid_date,
  A.AR_ID_ITEM AS LN_NBR,

  -- NME_ADDR preserved, with double-comma cleanup
  REPLACE(
    CONCAT_WS(
      ',',
      NVL(E.NME_LNE,''),
      NVL(E.DEST_LINE1_HOME,''),
      NVL(E.DEST_LINE2_HOME,''),
      NVL(E.LOC_LINE1_HOME,''),
      NVL(E.LOC_CITY_HOME,''),
      NVL(E.LOC_STATE_HOME,''),
      NVL(E.LOC_POSTAL_CODE_HOME,'')
    ),
    ',,',''
  ) AS NME_ADDR,

  B.RACLR_INTRST_TYPE AS INT_TYP,
  B.ARBLR_CNTRCT_AMT AS ORG_LN_AMT,

  -- DYS_PD_AHD preserved behavior (string with '-' removed, blank when null)
  NVL(
    REPLACE(
      CAST(
        DATEDIFF(
          TO_DATE(NVL(A.argblr_bill_due_date,' ')),
          TO_DATE(NVL(A.argblr_paid_date,' '))
        ) AS STRING
      ),
      '-',''
    ),
    ' '
  ) AS DYS_PD_AHD,

  C.OTSNDG_PRNCPL_BAL AS PRIN_BAL,
  B.IP_ID_PRMRY AS CUST_NBR,
  B.ENART_VALUE AS PROC_TYP,

  CASE
    WHEN D.CNTRT_CODE IN ('NoOfExtsnsForDlqcyPayment','NoOfExtsnsForDelinquency','NoOfExtsnsForPromotional','NoOfExtsnsForPymntDueDateChange')
     AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR
    ELSE ''
  END AS DQ_EXT_NBR_MOS,

  C.LTCHG_RCVBL AS LTE_CHRGS_DUE,
  B.APADL_VALUE AS PROC_STAT,
  C.TOTAL_FEE_RCVBL AS FEES_DUE,

  CASE WHEN E.home_phnbr IS NOT NULL THEN E.home_phnbr ELSE E.mobile_phnbr END AS PRI_PHN_EXT,

  A.ARGBLR_BILL_AMT AS PMT_AMT,

  CONCAT(10,'-',CASE WHEN D.CNTRT_CODE = 'TimesPastDue1' AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR ELSE 0 END) AS cnt_1,
  CONCAT(20,'-',CASE WHEN D.CNTRT_CODE = 'TimesPastDue2' AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR ELSE 0 END) AS cnt_2,
  CONCAT(30,'-',CASE WHEN D.CNTRT_CODE = 'TimesPastDue3' AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR ELSE 0 END) AS cnt_3,
  CONCAT(60,'-',CASE WHEN D.CNTRT_CODE = 'TimesPastDue4' AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR ELSE 0 END) AS cnt_4,
  CONCAT(90,'-',CASE WHEN D.CNTRT_CODE = 'TimesPastDue5' AND D.CNPT_VALUE = 'LifeToDate' THEN D.AACPTL_CNTR ELSE 0 END) AS cnt_5,

  E.business_phnbr AS BUS_PHN_EXT,

  -- PD_DTE and OLD_DUE_DTE formatting preserved
  NVL(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(CAST(A.argblr_paid_date AS DATE)), 'MM-dd-yyyy') AS STRING), '') AS PD_DTE,

  B.AR_ID_ITEM_ORG_UNIT AS BRNCH,

  NVL(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(CAST(C.PAST_DUE_DATE AS DATE)), 'MM-dd-yyyy') AS STRING), '') AS OLD_DUE_DTE,

  B.APD_CODE AS PROD_CDE,
  B.APD_NAME AS PROD_NME,
  A.LDBID AS LDBID,
  B.AR_ID_ITEM_OU_SERV AS AR_ID_ITEM_OU_SERV

FROM A
LEFT JOIN uat7400_racs11.RT_APD_AR_MSTR_LN_RL B
  ON A.AR_ID_ITEM = B.AR_ID_ITEM AND A.LDBID = B.LDBID
LEFT JOIN C_latest C
  ON A.AR_ID_ITEM = C.AR_ID_ITEM AND A.LDBID = C.LDBID
LEFT JOIN D_latest D
  ON A.AR_ID_ITEM = D.ARID_ITEM AND A.LDBID = D.LDBID
LEFT JOIN uat7400_racs11.TB_CUST_MSTR_IP E
  ON B.IP_ID_PRMRY = E.EC_IP_ID AND B.LDBID = E.LDBID;
